<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LW M√∫tuo Mercantil ‚Äî AutoCobran√ßas</title>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --accent:#06b6d4; --muted:#94a3b8; --text:#e6eef6;
      --success:#16a34a; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,Segoe UI,Arial,sans-serif; background:linear-gradient(180deg,#071127 0%, #071727 100%); color:var(--text);
      padding:24px;
    }
    .wrap{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr 420px;gap:20px;align-items:start}
    header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    h1{margin:0;font-size:20px}
    p.lead{margin:4px 0 0;color:var(--muted);font-size:13px}

    /* form card */
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06)); padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    label{display:block;font-size:13px;margin:8px 0 6px;color:var(--muted)}
    input[type="text"], input[type="date"], input[type="number"], textarea, select{
      width:100%; padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04); background:transparent;color:var(--text);
      outline:none;font-size:14px;
    }
    .row{display:flex;gap:8px}
    .row > *{flex:1}

    button.primary{
      display:inline-block;background:linear-gradient(90deg,var(--accent),#0ea5a6); color:#042027;padding:10px 14px;border-radius:10px;border:none;font-weight:600;cursor:pointer;margin-top:12px;
    }
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text);padding:8px 10px;border-radius:8px;cursor:pointer}
    small.muted{color:var(--muted);display:block;margin-top:8px;font-size:12px}

    /* right column */
    .panel{display:flex;flex-direction:column;gap:12px}
    .metrics{display:flex;gap:8px}
    .metric{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04)); padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);flex:1}
    .metric h3{margin:0;font-size:16px}
    .list{max-height:520px;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:8px}

    .clientRow{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg, rgba(0,0,0,0.03), rgba(255,255,255,0.01))}
    .clientInfo{flex:1}
    .clientActions{display:flex;gap:8px;align-items:center}

    .smallTag{font-size:12px;color:var(--muted)}

    /* associados list */
    .associadosList{display:flex;flex-direction:column;gap:8px;margin-top:6px}
    .associadoItem{display:flex;gap:8px}
    .associadoItem input{flex:1}

    footer{grid-column:1/-1;margin-top:18px;color:var(--muted);font-size:12px;text-align:center}
    @media(max-width:980px){ .wrap{grid-template-columns:1fr} .panel{order:2} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>LW M√∫tuo Mercantil ‚Äî AutoCobran√ßas</h1>
        <p class="lead">Cadastro r√°pido, c√°lculo autom√°tico de juros e envio por WhatsApp</p>
      </div>
      <div>
        <button class="ghost" id="btnRefresh">Atualizar valores</button>
        <button class="ghost" id="btnFetch">Recarregar clientes</button>
      </div>
    </header>

    <!-- Formul√°rio -->
    <div class="card">
      <h3>Registrar / Atualizar Cliente</h3>

      <label>Nome do Cliente</label>
      <input id="nome" type="text" placeholder="Jo√£o da Silva">

      <div class="row">
        <div>
          <label>Valor Base (R$)</label>
          <input id="valor_base" type="number" step="0.01" placeholder="1000.00">
        </div>
        <div>
          <label>Data do Cr√©dito</label>
          <input id="data_credito" type="date">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Juros Di√°rio (ex: 0.5 para 0,5)</label>
          <input id="juros_diario" type="number" step="0.0001" placeholder="0.5">
        </div>
        <div>
          <label>Juros M√™s (ex: 1.5)</label>
          <input id="juros_mensal" type="number" step="0.01" placeholder="1.5">
        </div>
      </div>

      <label>Objeto de Empenho</label>
      <input id="objeto_empenho" type="text" placeholder="Ex: Bem X">

      <label>Documento / Procura√ß√£o</label>
      <input id="documento" type="text" placeholder="Procura√ß√£o n¬∫ ...">

      <label>Associados</label>
      <div class="associadosList" id="associadosList">
        <div class="associadoItem">
          <input type="text" class="associadoInput" placeholder="Nome do associado">
          <button class="ghost btnRemoveAssoc" title="Remover" style="display:none">‚úñ</button>
        </div>
      </div>
      <div style="margin-top:8px">
        <button id="addAssoc" class="ghost">+ Adicionar associado</button>
      </div>

      <label>N√∫mero do WhatsApp (DDD + n√∫mero, ex: 5511999999999)</label>
      <input id="whatsapp" type="text" placeholder="5511999999999">

      <button id="btnSubmit" class="primary">üíæ Cadastrar e Calcular</button>
      <small class="muted">Ap√≥s cadastrar, utilize "Atualizar valores" para recarregar os clientes com juros atualizados.</small>
    </div>

    <!-- Painel direito: m√©tricas e lista -->
    <aside class="panel">
      <div class="card metrics">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h3 id="totalClientes">Clientes: 0</h3>
            <div class="smallTag">Valor total atualizado</div>
          </div>
          <div style="text-align:right">
            <h3 id="valorTotal">R$ 0,00</h3>
            <div class="smallTag">√öltima atualiza√ß√£o: <span id="ultimaAtual">‚Äî</span></div>
          </div>
        </div>
      </div>

      <div class="card" style="padding:12px">
        <h4>Clientes</h4>
        <div class="list" id="clientesList">
          <!-- preenchido pelo JS -->
        </div>
      </div>
    </aside>

    <footer>
      Desenvolvido para LW M√∫tuo Mercantil ‚Äî atualizado automaticamente.
    </footer>
  </div>

<script>
/*
  INSTRU√á√ÉO: substitua API_BASE pelo URL do seu backend (Render).
  Exemplo: const API_BASE = "https://autocobrancas.onrender.com";
*/
const API_BASE = "https://autocobrancas.onrender.com"; // <--- coloque o seu endpoint (sem barra final)

/* PIX de exemplo (edite para a sua chave/resumo) */
const PIX_INFO = "Chave PIX: 11.111.111-11 (LW M√∫tuo Mercantil)";

/* util */
const $ = sel => document.querySelector(sel);
const fmtMoney = v => Number(v).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});

/* associados helpers */
function addAssociado(value=''){
  const list = document.getElementById('associadosList');
  const item = document.createElement('div');
  item.className = 'associadoItem';
  item.innerHTML = `<input type="text" class="associadoInput" placeholder="Nome do associado" value="${value.replace(/"/g,'')}" />
                    <button class="ghost btnRemoveAssoc" title="Remover">‚úñ</button>`;
  list.appendChild(item);
  item.querySelector('.btnRemoveAssoc').addEventListener('click', ()=> {
    item.remove();
  });
}
document.getElementById('addAssoc').addEventListener('click', (e)=>{ e.preventDefault(); addAssociado(); });

/* carregar associados default */
document.addEventListener('DOMContentLoaded', ()=> {
  // deixa um campo vis√≠vel
  const defaultInput = document.querySelector('.associadoInput');
  if(!defaultInput) addAssociado();
});

/* enviar cadastro */
document.getElementById('btnSubmit').addEventListener('click', async (e)=>{
  e.preventDefault();
  const nome = $('#nome').value.trim();
  const valor_base = parseFloat($('#valor_base').value||0);
  const data_credito = $('#data_credito').value;
  const juros_diario = parseFloat($('#juros_diario').value||0);
  const juros_mensal = parseFloat($('#juros_mensal').value||0);
  const objeto_empenho = $('#objeto_empenho').value.trim();
  const documento = $('#documento').value.trim();
  const whatsapp = $('#whatsapp').value.trim();

  if(!nome || !data_credito || !valor_base) return alert('Preencha nome, data e valor base.');

  // pegar associados como array
  const associados = Array.from(document.querySelectorAll('.associadoInput')).map(i=>i.value.trim()).filter(Boolean);

  const payload = {
    nome, valor_base, juros_diario, juros_mensal, data_credito, objeto_empenho, documento, associados, telefone: whatsapp
  };

  try {
    const r = await fetch(API_BASE + '/cadastrar', {
      method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
    });
    const data = await r.json();
    if(!r.ok) {
      alert('Erro: ' + (data.erro || JSON.stringify(data)));
      return;
    }
    // mostrar resultado resumido
    alert('Cliente cadastrado com sucesso!\nValor atualizado: R$ ' + (data.cliente.valor_total).toFixed(2));
    // limpar formul√°rio parcial
    $('#nome').value=''; $('#valor_base').value=''; $('#juros_diario').value=''; $('#juros_mensal').value=''; $('#objeto_empenho').value=''; $('#documento').value=''; $('#whatsapp').value='';
    // manter associados
    // recarregar lista
    carregarClientes();
  } catch(err){
    console.error(err);
    alert('Erro de conex√£o com o servidor.');
  }
});

/* carregar clientes e preencher listagem */
async function carregarClientes(){
  try {
    const r = await fetch(API_BASE + '/clientes');
    if(!r.ok) { console.error('Erro ao buscar clientes', r.status); return; }
    const clientes = await r.json();
    // preencher
    const list = $('#clientesList');
    list.innerHTML = '';
    let total = 0;
    clientes.forEach((c, idx) => {
      total += Number(c.valor_total||0);
      const row = document.createElement('div');
      row.className = 'clientRow';
      row.innerHTML = `
        <div class="clientInfo">
          <div style="font-weight:700">${c.nome || '-'}</div>
          <div class="smallTag">Valor: R$ ${fmtMoney(c.valor_total||0)} ‚Ä¢ Dias: ${c.dias_corridos||0} ‚Ä¢ Juros/dia: ${c.juros_diario}</div>
          <div class="smallTag">Associados: ${(c.associados||[]).join(', ')}</div>
        </div>
        <div class="clientActions">
          <button class="ghost" data-idx="${idx}" onclick="abrirWhats(event)">üì±</button>
          <button class="ghost" data-idx="${idx}" onclick="editarCliente(event)">‚úèÔ∏è</button>
        </div>`;
      list.appendChild(row);
    });

    // m√©tricas
    $('#totalClientes').textContent = 'Clientes: ' + clientes.length;
    $('#valorTotal').textContent = 'R$ ' + fmtMoney(total);
    $('#ultimaAtual').textContent = new Date().toLocaleString('pt-BR');
  } catch(err){
    console.error('Erro carregar clientes', err);
  }
}

/* abrir whatsapp com mensagem pronta */
window.abrirWhats = function(ev){
  const idx = ev.currentTarget.getAttribute('data-idx');
  // buscar clientes atuais do backend (garante dados frescos)
  fetch(API_BASE + '/clientes').then(r=>r.json()).then(clientes=>{
    const c = clientes[idx];
    if(!c) return alert('Cliente n√£o encontrado');
    const phone = (c.telefone || '').replace(/\D/g,'');
    if(!phone) return alert('Telefone n√£o cadastrado para este cliente.');
    const mensagem = `Ol√° ${c.nome}, tudo bem?%0A%0A` +
      `Lembrete de cobran√ßa - LW M√∫tuo Mercantil%0A` +
      `Valor atualizado: R$ ${fmtMoney(c.valor_total)}%0A` +
      `Dias corridos: ${c.dias_corridos}%0A` +
      `Juros (dia): ${c.juros_diario}%0A` +
      `Data do cr√©dito: ${c.data_credito}%0A%0A` +
      `Pagamento via PIX: ${PIX_INFO}%0A%0A` +
      `Qualquer d√∫vida, responda essa mensagem.`;

    const url = `https://wa.me/55${phone}?text=${mensagem}`;
    window.open(url, '_blank');
  }).catch(e=>{ console.error(e); alert('Erro ao preparar mensagem WhatsApp'); });
}

/* editar cliente: carrega dados no formul√°rio (n√£o altera arquivo at√© submeter) */
window.editarCliente = function(ev){
  const idx = ev.currentTarget.getAttribute('data-idx');
  fetch(API_BASE + '/clientes').then(r=>r.json()).then(clientes=>{
    const c = clientes[idx];
    if(!c) return alert('Cliente n√£o encontrado');
    $('#nome').value = c.nome || '';
    $('#valor_base').value = c.valor_base || '';
    $('#data_credito').value = c.data_credito || '';
    $('#juros_diario').value = c.juros_diario || '';
    $('#juros_mensal').value = c.juros_mensal || '';
    $('#objeto_empenho').value = c.objeto_empenho || '';
    $('#documento').value = c.documento || '';
    $('#whatsapp').value = c.telefone || '';
    // associados
    const list = $('#associadosList'); list.innerHTML = '';
    (c.associados||[]).forEach(a=> addAssociado(a));
  }).catch(e=>{ console.error(e); alert('Erro ao carregar cliente'); });
}

/* bot√µes superiores */
$('#btnRefresh').addEventListener('click', async ()=> {
  // for√ßa atualizar clientes no backend e recarregar
  try {
    const r = await fetch(API_BASE + '/clientes');
    if(r.ok) {
      // backend j√° atualiza valores ao chamar /clientes
      carregarClientes();
      alert('Painel atualizado.');
    } else {
      alert('Erro ao atualizar no servidor.');
    }
  } catch(err){
    alert('Erro de conex√£o ao atualizar.');
  }
});

$('#btnFetch').addEventListener('click', carregarClientes);

/* inicial */
carregarClientes();
</script>
</body>
</html>
